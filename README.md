# Подготовка к выполнению
- Необязательно. Познакомьтесь с LightHouse.
- Создайте два пустых публичных репозитория в любом своём проекте: vector-role и lighthouse-role.
- Добавьте публичную часть своего ключа к своему профилю на GitHub.
# Основная часть
- Ваша цель — разбить ваш playbook на отдельные roles.
- Задача — сделать roles для ClickHouse, Vector и LightHouse и написать playbook для использования этих ролей.
- Ожидаемый результат — существуют три ваших репозитория: два с roles и один с playbook.
# Что нужно сделать
- Создайте в старой версии playbook файл requirements.yml и заполните его содержимым:
```
  - src: git@github.com:AlexeySetevoi/ansible-clickhouse.git
    scm: git
    version: "1.13"
    name: clickhouse
```
```
ansible-galaxy role install -p roles -r requirements.yml
Starting galaxy role install process
- clickhouse (1.11.0) is already installed, skipping.
```
- При помощи ansible-galaxy скачайте себе эту роль.
```
ansible-galaxy role init vector-role
- Role vector-role was created successfully
devops@WORKBOOK:~/ansible/mnt-homeworks/08-ansible-04-role/playbook$ cd vector-role
devops@WORKBOOK:~/ansible/mnt-homeworks/08-ansible-04-role/playbook/vector-role$ ls
README.md  defaults  files  handlers  meta  tasks  templates  tests  vars
ansible-galaxy role init lighthouse-role
- Role lighthouse-role was created successfully
devops@WORKBOOK:~/ansible/mnt-homeworks/08-ansible-04-role/playbook/roles/lighthouse-role$ ls
README.md  defaults  files  handlers  meta  tasks  templates  tests  vars
```
- Создайте новый каталог с ролью при помощи ansible-galaxy role init vector-role.
- На основе tasks из старого playbook заполните новую role. Разнесите переменные между vars и default.
- Перенести нужные шаблоны конфигов в templates.
- Опишите в README.md обе роли и их параметры. Пример качественной документации ansible role по ссылке.
- Повторите шаги 3–6 для LightHouse. Помните, что одна роль должна настраивать один продукт.
- Выложите все roles в репозитории. Проставьте теги, используя семантическую нумерацию. Добавьте roles в requirements.yml в playbook.
- Переработайте playbook на использование roles. Не забудьте про зависимости LightHouse и возможности совмещения roles с tasks.
 - [lighthouse-role](https://github.com/EVolgina/lighthouse-role.git)
 - [vector-role](https://github.com/EVolgina/vector-role.git)
 - [ClickHouse](https://github.com/EVolgina/clickhouse-role.git)
- Выложите playbook в репозиторий.
- В ответе дайте ссылки на оба репозитория с roles и одну ссылку на репозиторий с playbook. 
```
ansible-playbook -i ./inventory/prod.yml site.yml --diff 
PLAY [Install Clickhouse] **********************************************************************************************************************************************
TASK [Gathering Facts] *************************************************************************************************************************************************
ok: [84.252.130.159]
TASK [clickhouse : Get clickhouse distrib] *****************************************************************************************************************************
ok: [84.252.130.159] => (item=clickhouse-client)
ok: [84.252.130.159] => (item=clickhouse-server)
ok: [84.252.130.159] => (item=clickhouse-common-static)
TASK [clickhouse : Install clickhouse packages] ************************************************************************************************************************
ok: [84.252.130.159]
TASK [clickhouse : Flush handlers] *************************************************************************************************************************************
TASK [clickhouse : Create database] ************************************************************************************************************************************
ok: [84.252.130.159]
PLAY [Install Vector] **************************************************************************************************************************************************
TASK [Gathering Facts] *************************************************************************************************************************************************
ok: [51.250.67.161]
TASK [vector-role : Get Vector distrib] ********************************************************************************************************************************
ok: [51.250.67.161]
TASK [vector-role : Install Vector] ************************************************************************************************************************************
ok: [51.250.67.161]
PLAY [Install Lighthouse] **********************************************************************************************************************************************
TASK [lighthouse-role : Ensure Ansible uses Python 3] ******************************************************************************************************************
ok: [130.193.39.135]
TASK [lighthouse-role : Install unzip] *********************************************************************************************************************************
ok: [130.193.39.135]
TASK [lighthouse-role : Get Lighthouse distrib] ************************************************************************************************************************
changed: [130.193.39.135]
TASK [lighthouse-role : Unarchive Lighthouse distrib into nginx] *******************************************************************************************************
ok: [130.193.39.135]
TASK [lighthouse-role : Make nginx config] *****************************************************************************************************************************
ok: [130.193.39.135]
TASK [lighthouse-role : Remove Lighthouse distrib] *********************************************************************************************************************
--- before
+++ after
@@ -1,4 +1,4 @@
 {
     "path": "/home/devops/lighthouse.zip",
-    "state": "file"
+    "state": "absent"
 }

changed: [130.193.39.135]
PLAY RECAP *************************************************************************************************************************************************************
130.193.39.135             : ok=6    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
51.250.67.161              : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
84.252.130.159             : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```
# После обновления настроек vector запустила ansible-playbook -i ./inventory/prod.yml site.yml
(виртуальный машины получили новые IP)
```
PLAY [Install Clickhouse] **********************************************************************************************************************************************
TASK [Gathering Facts] *************************************************************************************************************************************************
ok: [158.160.34.156]
TASK [clickhouse : Get clickhouse distrib] *****************************************************************************************************************************
ok: [158.160.34.156] => (item=clickhouse-client)
ok: [158.160.34.156] => (item=clickhouse-server)
ok: [158.160.34.156] => (item=clickhouse-common-static)
TASK [clickhouse : Install clickhouse packages] ************************************************************************************************************************
ok: [158.160.34.156]
TASK [clickhouse : Flush handlers] *************************************************************************************************************************************
TASK [clickhouse : Create database] ************************************************************************************************************************************
ok: [158.160.34.156]
PLAY [Install Vector] **************************************************************************************************************************************************
TASK [Gathering Facts] *************************************************************************************************************************************************
ok: [158.160.123.170]
TASK [vector-role : Get Vector distrib] ********************************************************************************************************************************
ok: [158.160.123.170]
TASK [vector-role : Install Vector] ************************************************************************************************************************************
ok: [158.160.123.170]
TASK [vector-role : Create Vector configuration file] ******************************************************************************************************************
ok: [158.160.123.170]
PLAY [Install Lighthouse] **********************************************************************************************************************************************
TASK [lighthouse-role : Ensure Ansible uses Python 3] ******************************************************************************************************************
ok: [158.160.104.59]
TASK [lighthouse-role : Install unzip] *********************************************************************************************************************************
ok: [158.160.104.59]
TASK [lighthouse-role : Create a directory for Lighthouse distrib] *****************************************************************************************************
ok: [158.160.104.59]
TASK [lighthouse-role : Get Lighthouse distrib] ************************************************************************************************************************
changed: [158.160.104.59]
TASK [lighthouse-role : Unarchive Lighthouse distrib into nginx] *******************************************************************************************************
ok: [158.160.104.59]
TASK [lighthouse-role : Make nginx config] *****************************************************************************************************************************
ok: [158.160.104.59]
TASK [lighthouse-role : Remove Lighthouse distrib] *********************************************************************************************************************
changed: [158.160.104.59]
PLAY RECAP *************************************************************************************************************************************************************
158.160.104.59             : ok=7    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
158.160.123.170            : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
158.160.34.156             : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

```
